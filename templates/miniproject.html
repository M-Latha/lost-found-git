<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LocateNow-Report . Track . Reunite</title>
<style>
:root{
  --purple-1: #6a0dad;
  --purple-2: #8e44ad;
  --accent:   #7b2cbf;
  --bg-1:     #f8f4fb;
  --bg-2:     #f5f0fa;
  --card-bg:  #ffffff;
  --muted:    #444;
  --success:  #2d8a4d;
  --danger:   #d64545;
  --shadow:   rgba(20,10,40,0.08);
  --radius:   12px;
}

* { box-sizing: border-box; margin:0; padding:0; }

body{
  font-family: "Poppins", "Segoe UI", Tahoma, sans-serif;
  background: linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
  color:#222;
}

/* HEADER */
header {
  background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
  color:white;
  padding: 18px 16px;
  text-align: center;
  font-size:20px;
  font-weight:700;
}

/* PAGE */
.page {
  display:none;
  min-height: calc(100vh - 80px);
  padding:36px 20px;
}
.page.centered {
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

/* BUTTONS */
.btn{
  background:linear-gradient(90deg,var(--accent),#9d4edd);
  padding:12px 26px;
  border:none;
  border-radius:10px;
  color:white;
  font-weight:600;
  cursor:pointer;
}
.back-btn{
  background:white;
  border:2px solid #e4d6ff;
  border-radius:8px;
  padding:8px 16px;
  cursor:pointer;
  color:var(--purple-1);
}

/* LOGIN */
.login-card{
  width:720px;
  max-width:95%;
  background:#fff;
  padding:26px;
  border-radius:14px;
  box-shadow:0 10px 26px var(--shadow);
  margin:auto;
}

input[type="text"], input[type="date"], select, textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #e4d6ff;
  margin-top:6px;
  margin-bottom:12px;
  font-size:14px;
}

/* BIGGER DESCRIPTION */
textarea{
  min-height:140px;
  resize: vertical;
}

/* DASHBOARD */
.dashboard-grid{
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns: 1fr 300px;
  gap:24px;
}

/* WELCOME CARD */
.welcome-card {
    width: 750px;
    max-width: 90%;
    min-height: 180px;
    overflow: hidden;
    padding: 28px;
    background: white;
    border-radius: 14px;
    box-shadow:0 10px 26px rgba(0,0,0,0.05);
    margin:auto;
}
#quoteText {
    display: block;
    margin-top: 10px;
    text-align: left;
    font-weight: 700;
    font-size: 20px;
    color: #8A2BE2;
}

/* QUICK STATS */
.stats-card{
  background:white;
  border-radius:14px;
  padding:22px;
  box-shadow:0 10px 26px rgba(94,0,135,0.08);
  border-left:6px solid var(--purple-2);
}

/* CATEGORY COUNTS */
#catCounts div{
  background:#faf6ff;
  border-radius:8px;
  padding:6px 12px;
  font-weight:600;
  border:1px solid #e1cef9;
  color:#4a0072;
  margin-bottom:6px;
  box-shadow:0 3px 6px rgba(94,0,135,0.06);
}

/* CATEGORY BUTTONS */
/* CATEGORY BUTTONS ‚Äì CLEAN, NEAT & EVEN */
.cat-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
/* CATEGORY PANEL */
.cat-col {
  width: 230px;
  background: #ffffff;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5d9ff;
}

/* CATEGORY TITLE */
.cat-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  color: #6a0dad;
  letter-spacing: 0.3px;
}

/* VERTICAL CATEGORY BUTTONS */
.cat-list {
  display: flex;
  flex-direction: column;   /* Force vertical layout */
  gap: 10px;                /* Space between buttons */
}

/* BUTTON STYLE */
.cat-list button {
  width: 100%;  
  padding: 12px;
  border-radius: 10px;
  background: #f8f3ff;
  border: 1px solid #d5c7ff;
  font-size: 14px;
  font-weight: 600;
  text-align: left;         /* Makes it look official */
  cursor: pointer;
  transition: 0.25s ease;
}

/* HOVER */
.cat-list button:hover {
  background: #eadcff;
  border-color: #b89efc;
  transform: translateX(5px);
}
/* ITEM CARDS */
.item-card {
  width:260px;
  background:white;
  border-radius:12px;
  padding:12px;
  box-shadow:0 6px 18px rgba(20,10,40,0.06);
}
.item-card img{
  width:100%;
  height:140px;
  object-fit:cover;
  border-radius:8px;
}

/* FORM CARD */
.report-card{
  width:520px;
  background:white;
  padding:26px;
  border-radius:14px;
  box-shadow:0 10px 28px rgba(0,0,0,0.06);
  margin:auto;
}

/* layout changes for categories + items */
.cat-col {
  width:180px;
  padding:12px;
  background:white;
  border-radius:10px;
  box-shadow:0 4px 16px rgba(0,0,0,0.05);
}

.view-layout {
  display:grid;
  grid-template-columns: 220px 1fr;
  gap:24px;
}

.items-wrap {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap:20px;
}

/* Mobile Responsive */
@media(max-width: 768px) {
  .dashboard-grid { grid-template-columns: 1fr; padding: 10px; }
  .welcome-card, .stats-card { width: 100%; margin-bottom: 18px; }
  .view-layout { display: block; }
  .cat-col { width: 100%; margin-bottom: 14px; }
  .item-card { width: 100%; }
  img { width: 100% !important; height: auto !important; }
  .btn, .back-btn { width: 100%; text-align: center; display: block; margin-top: 6px; }
}
</style>
</head>
<body>

<header>
  <h1>LocateNow - Report ¬∑ Track ¬∑ Reunite</h1>
</header>

<section id="loginPage" class="page centered" style="display:flex;">
  <div class="login-card">
    <h2 style="text-align:center;margin:0 0 14px;color:var(--purple-1)">Login to Continue</h2>

    <form id="loginForm">
      <div class="form-row">
        <label for="loginName">Name:</label>
        <input id="loginName" type="text" required />
      </div>

      <div class="form-row">
        <label for="loginUSN">USN :</label>
        <input id="loginUSN" type="text" maxlength="10" required />
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
        <button class="btn" type="submit" style="padding:10px 18px;">Login</button>
        <div id="loginError" style="color:var(--danger);font-weight:700;display:none;">‚ùå Invalid USN</div>
      </div>
    </form>

    <div class="small-note" style="text-align:center;margin-top:12px;">Use your college USN</div>
  </div>
</section>

<section id="homePage" class="page centered" style="display:none;">
  <div class="dashboard-grid">
    <div class="welcome-card">
      <h2>Welcome!</h2>
      <p style="color:var(--muted)">Use this portal to report lost or found items on campus.</p>

     <div id="quoteText">Helping lost items find their way home.</div>

      <div style="margin-top:18px; display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn" onclick="showReportPage()">‚ûï Report Item</button>
        <button class="btn" onclick="showViewChoice()">üëÄ View Items</button>
      </div>
    </div>

    <div class="stats-card">
      <h3>Quick Stats</h3>
      <div><b>Total Items: </b><span id="statTotal">0</span></div>
      <div><b>Lost Items: </b><span id="statLost">0</span></div>
      <div><b>Found Items: </b><span id="statFound">0</span></div>

      <hr style="margin:12px 0;">
      <b>Category counts</b>
      <div id="catCounts"></div>
    </div>
  </div>
</section>

<section id="reportPage" class="page centered" style="display:none;">
  <div class="report-card">
    <h2>Report Item</h2>
    <form id="itemForm" enctype="multipart/form-data">

      <label>Your Name:</label>
      <input id="reportName" name="name" type="text" readonly />

      <label>Your USN:</label>
      <input id="reportUSN" name="usn" type="text" maxlength="10" readonly />

      <label>Choose one:</label>
      <select id="type" name="type" required>
        <option value="">Select Type</option>
        <option value="Lost">Lost Item</option>
        <option value="Found">Found Item</option>
      </select>

      <label>Item Category:</label>
      <select id="category" name="category" required>
        <option value="">Select Category</option>
        <option>Books</option>
        <option>ID Card</option>
        <option>Electronics</option>
        <option>Water Bottle</option>
        <option>Bag</option>
        <option>Keys</option>
        <option>Other</option>
      </select>

      <label>Contact:</label>
      <input id="contact" name="contact" type="text" maxlength="10" required />

      <label>Item Details:</label>
      <textarea id="details" name="details" placeholder="Describe the item" required></textarea>

      <label>Date:</label>
      <input id="date" name="date" type="date" required />

      <label>Upload Item Image (optional):</label>
      <input id="itemImage" name="image" type="file" accept="image/*" />

      <div style="display:flex; gap:12px; align-items:center; margin-top:10px;">
        <button class="btn" id="submitBtn" type="submit">Submit</button>
        <button class="back-btn" type="button" onclick="backToHome()">‚¨Ö Back</button>
        <div id="submitMsg" style="display:none;font-weight:700;"></div>
      </div>

    </form>
  </div>
</section>

<section id="viewChoicePage" class="page centered" style="display:none;">
  <div style="width:520px; max-width:94%; text-align:center; margin:auto;">
    <div style="background:var(--card-bg); padding:26px; border-radius:12px; box-shadow:0 10px 24px rgba(80,40,120,0.06);">
      <h2 style="margin:0;color:var(--purple-1)">View Items</h2>
      <p style="color:var(--muted); margin-top:8px;">Choose which list you want to see</p>
      <div style="display:flex; gap:12px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" onclick="showLostItems()">üìï View Lost Items</button>
        <button class="btn" onclick="showFoundItems()">üìó View Found Items</button>
      </div>
      <div style="margin-top:14px;"><button class="back-btn" onclick="backToHome()">‚¨Ö Back</button></div>
    </div>
  </div>
</section>

<section id="lostItemsPage" class="page" style="display:none;">
  <div style="max-width:1100px;margin:6px auto;">
    <h2 style="color:var(--purple-1);margin-top:6px;">üìï Lost Items</h2>
    <div class="view-layout">
      <div class="cat-col">
        <div class="cat-title">Categories</div>
        <div id="lostCatList" class="cat-list"></div>
      </div>

      <div style="flex:1">
        <div id="lostItemsList" class="items-wrap"></div>
      </div>
    </div>
    <div style="text-align:center;margin-top:10px;"><button class="back-btn" onclick="backToViewChoice()">‚¨Ö Back</button></div>
  </div>
</section>

<section id="foundItemsPage" class="page" style="display:none;">
  <div style="max-width:1100px;margin:6px auto;">
    <h2 style="color:var(--purple-1);margin-top:6px;">üìó Found Items</h2>
    <div class="view-layout">
      <div class="cat-col">
        <div class="cat-title">Categories</div>
        <div id="foundCatList" class="cat-list"></div>
      </div>

      <div style="flex:1">
        <div id="foundItemsList" class="items-wrap"></div>
      </div>
    </div>
    <div style="text-align:center;margin-top:10px;"><button class="back-btn" onclick="backToViewChoice()">‚¨Ö Back</button></div>
  </div>
</section>
<script>
/* ===== CONFIG ===== */
const ADMIN_USN = "3BRAMD0001"; // <-- set your admin USN here (must match backend ADMIN_USN)

/* ===== DOM refs ===== */
let loginPage = document.getElementById("loginPage"),
    homePage = document.getElementById("homePage"),
    reportPage = document.getElementById("reportPage"),
    viewChoicePage = document.getElementById("viewChoicePage"),
    lostItemsPage = document.getElementById("lostItemsPage"),
    foundItemsPage = document.getElementById("foundItemsPage"),
    loginForm = document.getElementById("loginForm"),
    loginUSN = document.getElementById("loginUSN"),
    loginName = document.getElementById("loginName"),
    loginError = document.getElementById("loginError"),
    itemForm = document.getElementById("itemForm"),
    reportUSN = document.getElementById("reportUSN"),
    reportName = document.getElementById("reportName"),
    submitMsg = document.getElementById("submitMsg"),
    lostItemsList = document.getElementById("lostItemsList"),
    foundItemsList = document.getElementById("foundItemsList"),
    lostCatList = document.getElementById("lostCatList"),
    foundCatList = document.getElementById("foundCatList"),
    statTotal = document.getElementById("statTotal"),
    statLost = document.getElementById("statLost"),
    statFound = document.getElementById("statFound"),
    catCounts = document.getElementById("catCounts"),
    quoteText = document.getElementById("quoteText"),
    viewLostBtn = null,
    viewFoundBtn = null;

const CATEGORIES = ["All","Books","ID Card","Electronics","Water Bottle","Bag","Keys","Other"];
let items = [];
let currentUser = { name: "", usn: "", isAdmin: false };

/* ===== helper: loads items from backend ===== */
async function loadItems(){
  try{
    const r = await fetch("/get_items");
    if(!r.ok) { console.error("get_items fetch failed", r.status); return; }
    items = await r.json();
    refreshDashboard();
  }catch(err){
    console.error("loadItems error:", err);
  }
}

/* ===== login ===== */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    let usn = loginUSN.value.trim().toUpperCase();
    let name = loginName.value.trim();

    // Keep existing validation: 10 chars and starting with 3BR
    if(usn.length !== 10 || !usn.startsWith("3BR")){
      loginError.style.display = "block";
      setTimeout(()=> loginError.style.display = "none", 1500);
      return;
    }

    currentUser = { name, usn, isAdmin:false };
    if(usn === ADMIN_USN) {
      currentUser.isAdmin = true;
      console.log("Admin logged in");
    }

    // set readonly report fields
    if(reportName) reportName.value = currentUser.name;
    if(reportUSN) reportUSN.value = currentUser.usn;

    showHome();
    await loadItems();
  } catch (err) {
    console.error("login error:", err);
  }
});

/* ===== page helpers ===== */
function hideAll(){
  [loginPage, homePage, reportPage, viewChoicePage, lostItemsPage, foundItemsPage].forEach(p=>{
    if(p) p.style.display = "none";
  });
}
function showHome(){ hideAll(); if(homePage) homePage.style.display = "block"; }
function showReportPage(){ hideAll(); if(reportPage) reportPage.style.display = "block"; }
function showViewChoice(){ hideAll(); if(viewChoicePage) viewChoicePage.style.display = "block"; }
function backToHome(){ showHome(); }
function backToViewChoice(){ hideAll(); if(viewChoicePage) viewChoicePage.style.display = "block"; }

/* ===== submit item handler ===== */
itemForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  // ensure current user values are present in form
  if(reportName) reportName.value = currentUser.name || reportName.value;
  if(reportUSN) reportUSN.value = currentUser.usn || reportUSN.value;

  let f = new FormData(itemForm);

  if(!f.get("type") || !f.get("category")){
    showSubmitMessage("‚ùå Select type & category", "red");
    return;
  }

  try {
    const r = await fetch("/submit", { method: "POST", body: f });
    const j = await r.json();
    if(j.status === "success"){
      showSubmitMessage("‚úÖ Submitted!", "green");
      itemForm.reset();
      if(reportName) reportName.value = currentUser.name;
      if(reportUSN) reportUSN.value = currentUser.usn;
      await loadItems();
    } else {
      console.error("submit failed:", j);
      showSubmitMessage("‚ùå Something went wrong", "red");
    }
  } catch(err) {
    console.error("submit error:", err);
    showSubmitMessage("‚ùå Network error", "red");
  }
});

function showSubmitMessage(text, color){
  if(!submitMsg) return;
  submitMsg.style.display = "block";
  submitMsg.style.color = color;
  submitMsg.textContent = text;
  setTimeout(()=> submitMsg.style.display = "none", 2000);
}

/* ===== categories builder ===== */
function buildCats(){
  if(!lostCatList || !foundCatList) return;
  lostCatList.innerHTML = "";
  foundCatList.innerHTML = "";
  CATEGORIES.forEach(c=>{
    let btnL = document.createElement("button");
    btnL.textContent = c;
    btnL.className = "";
    btnL.addEventListener("click", ()=> renderItems("Lost", c));
    lostCatList.appendChild(btnL);

    let btnF = document.createElement("button");
    btnF.textContent = c;
    btnF.addEventListener("click", ()=> renderItems("Found", c));
    foundCatList.appendChild(btnF);
  });
}

/* ===== render items (with image path and delete control) ===== */
function renderItems(type, cat){
  let box = (type === "Lost") ? lostItemsList : foundItemsList;
  if(!box) return;
  box.innerHTML = "";

  let filtered = items.filter(i => i.type === type && (cat === "All" || i.category === cat));

  if(filtered.length === 0){
    box.innerHTML = "<div style='padding:10px;font-weight:600;color:#555'>No items found</div>";
    return;
  }

  filtered.forEach(it => {
    // image path stored by backend should be browser path like "/static/uploads/filename.ext"
    let imgTag = it.img ? `<img src="${it.img}" style="width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:8px;">` : "";

    let canDelete = (currentUser.isAdmin === true) || (it.usn === currentUser.usn);
    let deleteHtml = canDelete ? `<button onclick="deleteItem('${it.id}','${type}')">Delete</button>` : `<div style="font-size:13px;color:#888;">(You cannot delete this)</div>`;

    // escape backticks/newlines for inline JS in Copy button
    const dEsc = escapeForInline(it.details);
    const cEsc = escapeForInline(it.contact);
    const nEsc = escapeForInline(it.name);
    const uEsc = escapeForInline(it.usn);

    box.innerHTML += `
      <div class="item-card">
        ${imgTag}
        <h3>${it.category}</h3>
        <p><b>Details:</b> ${it.details}</p>
        <p><b>Date:</b> ${formatDate(it.date)}</p>
        <p><b>Reporter:</b> ${it.name} (${it.usn})</p>
        <p><b>Contact:</b> ${it.contact}</p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button onclick="copyDetails(\`${dEsc}\`,\`${cEsc}\`,\`${nEsc}\`,\`${uEsc}\`)">Copy</button>
          ${deleteHtml}
        </div>
      </div>
    `;
  });
}

function escapeForInline(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/`/g, '\\`').replace(/\n/g, '\\n').replace(/\r/g, '');
}

/* ===== delete item (sends logged-in usn to backend for check) ===== */
async function deleteItem(id, t){
  if(!confirm("Are you sure you want to delete this item?")) return;
  try{
    let f = new FormData();
    f.append("id", id);
    f.append("usn", currentUser.usn || "");
    const r = await fetch("/delete_item", { method: "POST", body: f });
    const j = await r.json();
    if(j.status === "unauthorized"){
      alert("‚ùå You cannot delete this item.");
      return;
    }
    if(j.status === "deleted"){
      await loadItems();
      renderItems(t, "All");
    } else {
      alert("‚ùå Delete failed");
      console.error("delete response:", j);
    }
  }catch(err){
    console.error("delete error:", err);
    alert("‚ùå Delete failed (network)");
  }
}

/* ===== dashboard refresh ===== */
function refreshDashboard(){
  if(statTotal) statTotal.textContent = items.length;
  if(statLost) statLost.textContent = items.filter(x=>x.type==="Lost").length;
  if(statFound) statFound.textContent = items.filter(x=>x.type==="Found").length;

  if(catCounts) {
    catCounts.innerHTML = "";
    CATEGORIES.slice(1).forEach(c=>{
      let n = items.filter(x=>x.category === c).length;
      let div = document.createElement("div");
      div.textContent = `${c}: ${n}`;
      catCounts.appendChild(div);
    });
  }

  // re-render open view pages if visible
  if(lostItemsPage && lostItemsPage.style.display === "block"){
    renderItems("Lost", "All");
  }
  if(foundItemsPage && foundItemsPage.style.display === "block"){
    renderItems("Found", "All");
  }
}

/* ===== copy details ===== */
function copyDetails(details, contact, name, usn){
  let text = `Reporter: ${name} (${usn})\nContact: ${contact}\nDetails: ${details}`;
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=> alert("‚úÖ Details copied")).catch(()=> fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text){
  let ta = document.createElement("textarea");
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
  alert("‚úÖ Details copied");
}

/* ===== date format helper ===== */
function formatDate(d){
  if(!d) return "";
  let parts = d.split("-");
  if(parts.length !== 3) return d;
  return `${parts[2]}/${parts[1]}/${parts[0]}`;
}

/* ===== quotes rotate (box stable) ===== */
let QUOTES = [
  "Every lost thing has a story waiting to be reunited.",
  "Bringing the lost back to where they belong.",
  "Helping lost items find their way home."
];
let qi = 0;
function rotateQuotes(){ if(quoteText) quoteText.innerText = QUOTES[qi]; qi = (qi+1) % QUOTES.length; }

/* ===== robust UI init for view buttons and category wiring ===== */
function initUI(){
  try {
    // wire "View Items" buttons from the view choice page (defensive)
    const viewPageButtons = viewChoicePage ? viewChoicePage.querySelectorAll('button') : [];
    viewPageButtons.forEach(b=>{
      const txt = b.textContent ? b.textContent.toLowerCase() : "";
      if(txt.includes("lost")){
        b.addEventListener("click", (ev)=>{
          ev.preventDefault();
          showLostItems();
        });
      } else if(txt.includes("found")){
        b.addEventListener("click", (ev)=>{
          ev.preventDefault();
          showFoundItems();
        });
      }
    });

    // also ensure top-level buttons on home page work (if inline removed)
    const homeBtns = homePage ? homePage.querySelectorAll('button') : [];
    homeBtns.forEach(b=>{
      const txt = b.textContent ? b.textContent.toLowerCase() : "";
      if(txt.includes("report")){
        b.addEventListener("click", ()=> showReportPage());
      } else if(txt.includes("view")){
        b.addEventListener("click", ()=> showViewChoice());
      }
    });

    // build categories
    buildCats();
  } catch(err){
    console.error("initUI error:", err);
  }
}

/* ===== helper view functions (used by UI) ===== */
function showLostItems(){ hideAll(); if(lostItemsPage) lostItemsPage.style.display = "block"; buildCats(); renderItems("Lost", "All"); }
function showFoundItems(){ hideAll(); if(foundItemsPage) foundItemsPage.style.display = "block"; buildCats(); renderItems("Found", "All"); }

/* ===== startup ===== */
setInterval(rotateQuotes, 2500);
(function start(){
  try {
    hideAll();
    if(loginPage) loginPage.style.display = "flex";
    initUI();
    rotateQuotes();
    loadItems();
  } catch(err){
    console.error("startup error:", err);
  }
})();
</script>
</body>
</html>
